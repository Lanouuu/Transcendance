events {
    
}

http {

    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    map $http_accept $nav_request {
        default 0;
        "~*text/html" 1;
    }

    server {
        listen 8080;

        location / {
            return 301 https://$host:8443$request_uri;
        }
    }   

    server {
        listen 443 ssl;
        server_name $DOMAIN_NAME;
        root /etc/nginx/html;

        ssl_certificate /etc/nginx/ssl/transcendence.crt;
        ssl_certificate_key /etc/nginx/ssl/transcendence.key;
        ssl_protocols TLSv1.3;

        error_page 400 =302 "$scheme://$http_host/#error?code=400";
        error_page 401 =302 "$scheme://$http_host/#error?code=401";
        error_page 403 =302 "$scheme://$http_host/#error?code=403";
        error_page 404 =302 "$scheme://$http_host/#error?code=404";
        error_page 500 502 503 504 =302 "$scheme://$http_host/#error?code=500";

        location = /errors { 
            return 308 $scheme://$http_host/errors/; 
        }
        location = /errors/ {
            return 308 "$scheme://$http_host/#error?code=404"; 
        }
        location /errors/ {
            internal;
            root /etc/nginx/html;
        }

        location / {
            try_files $uri $uri/ /index.html;
        }

        
        location = /auth_service { 
            return 308 $scheme://$http_host/auth_service/; 
        }
        location = /auth_service/ {
            return 308 "$scheme://$http_host/#error?code=404"; 
        }

        location = /auth_service/login/42 {
            proxy_pass http://auth_service:3001/login/42;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location /auth_service/login/42/callback {
            proxy_intercept_errors on;
            proxy_pass http://auth_service:3001/login/42/callback;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Authorization $http_authorization;
        }

        location /auth_service/ {
            if ($nav_request) {
                return 302 "$scheme://$http_host/#error?code=404";
            }
            proxy_pass http://auth_service:3001/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Authorization $http_authorization;
        }

        location = /auth_check {
            internal;
            proxy_pass http://auth_service:3001/verify;
            proxy_set_header Authorization $http_authorization;
            proxy_set_header Accept application/json;  
        }

        location = /users/save-match {
            deny all;
            return 403;
        }

        location = /users/create_user {
            deny all;
            return 403;
        }

        location ~ ^/users/(name|mail)/.+ {
            deny all;
            return 403;
        }

        location = /users/create-guest {
            if ($nav_request) {
                return 302 "$scheme://$http_host/#error?code=404";
            }
            proxy_pass http://users:3000/create-guest;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Content-Type application/json;
        }

        location = /users { 
            return 308 $scheme://$http_host/users/; 
        }
        location = /users/ {
            return 308 "$scheme://$http_host/#error?code=404"; 
        }

        location /users/heartbeat {
            if ($nav_request) {
                return 302 "$scheme://$http_host/#error?code=404";
            }
            auth_request /auth_check;
            auth_request_set $user_id $upstream_http_x_user_id;
            proxy_pass http://users:3000/heartbeat;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Authorization $http_authorization;
            proxy_set_header X-User-ID $user_id;
        }

        location /users/ {
            if ($nav_request) {
                return 302 "$scheme://$http_host/#error?code=404";
            }
            auth_request /auth_check;
            auth_request_set $user_id $upstream_http_x_user_id;
            proxy_pass http://users:3000/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Authorization $http_authorization;
            proxy_set_header X-User-ID $user_id;
        }

       location = /game { 
            return 308 $scheme://$http_host/game/; 
        }
        location = /game/ {
            return 308 "$scheme://$http_host/#error?code=404"; 
        }
        location /game/ {
            if ($nav_request) {
                return 302 "$scheme://$http_host/#error?code=404";
            }
            auth_request /auth_check;
            auth_request_set $user_id $upstream_http_x_user_id;
            proxy_pass https://game:3002/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-User-ID $user_id;
        }

        location /game/ws {
            proxy_intercept_errors on;
            proxy_pass https://game:3002/ws;

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_connect_timeout 7d;
            proxy_send_timeout 7d;
            proxy_read_timeout 7d;
        }

        location = /second_game { 
            return 308 $scheme://$http_host/second_game/; 
        }
        location = /second_game/ {
            return 308 "$scheme://$http_host/#error?code=404"; 
        }
        location /second_game/ {
            if ($nav_request) {
                return 302 "$scheme://$http_host/#error?code=404";
            }
            auth_request /auth_check;
            auth_request_set $user_id $upstream_http_x_user_id;
            proxy_pass https://second_game:3003/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-User-ID $user_id;
        }

        location /tournament/ {
            auth_request /auth_check; 
            proxy_pass https://tournament:3004/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # location /tournament/ws {
        #     proxy_pass https://tournament:3004/ws;

        #     proxy_http_version 1.1;
        #     proxy_set_header Upgrade $http_upgrade;
        #     proxy_set_header Connection "upgrade";
            
        #     proxy_set_header Host $host;
        #     proxy_set_header X-Real-IP $remote_addr;
        #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        #     proxy_set_header X-Forwarded-Proto $scheme;
            
        #     proxy_connect_timeout 7d;
        #     proxy_send_timeout 7d;
        #     proxy_read_timeout 7d;
        # }

        # A decommenter quand Mervan aura implementer ses websockets

        location /second_game/ws {
            proxy_intercept_errors on;
            proxy_pass https://second_game:3003/ws;

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_connect_timeout 7d;
            proxy_send_timeout 7d;
            proxy_read_timeout 7d;
        }

    }
}